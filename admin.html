<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Admin Panel</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Firebase SDK v8 -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<style>
body{
 margin:0;
 font-family:Arial;
 background:#0f1220;
 color:#fff
}
.header{
 background:#ff6a00;
 padding:15px;
 text-align:center;
 font-size:18px;
 font-weight:bold
}
.card{
 background:#161a2e;
 margin:15px;
 padding:15px;
 border-radius:12px
}
button{
 padding:8px 12px;
 margin:6px 4px;
 border:none;
 border-radius:8px;
 background:#ff6a00;
 color:#fff;
 font-weight:bold;
 cursor:pointer
}
input{
 width:100%;
 padding:10px;
 margin:8px 0;
 border-radius:8px;
 border:none
}
small{color:#aaa}
</style>
</head>

<body>

<div class="header">Admin Panel</div>

<!-- LOGIN -->
<div id="loginBox" class="card">
 <input id="email" placeholder="Admin Email">
 <input id="password" type="password" placeholder="Password">
 <button onclick="adminLogin()">Login</button>
</div>

<!-- ADMIN AREA -->
<div id="adminBox" style="display:none">

 <!-- PAYMENTS -->
 <div class="card">
  <h3>Pending Payments</h3>
  <div id="payments"></div>
 </div>

 <!-- WITHDRAW -->
 <div class="card">
  <h3>Withdraw Requests</h3>
  <div id="withdraws"></div>
 </div>

 <!-- COINS MANAGER -->
 <div class="card">
  <h3>Manage User Coins</h3>

  <input id="coinUid" placeholder="User UID">
  <input id="coinAmount" type="number" placeholder="Amount (eg. 50)">

  <button onclick="addCoinsAdmin()">âž• Add Coins</button>
  <button onclick="deductCoinsAdmin()">âž– Deduct Coins</button>

  <p id="coinMsg" style="color:#7CFF7C;font-size:14px"></p>
 </div>

</div>

<script>
/* ðŸ”¥ FIREBASE CONFIG */
firebase.initializeApp({
 apiKey:"AIzaSyArCdfGSLZQi8CBbw7is71kxB5036Wlj5E",
 authDomain:"calling-98df6.firebaseapp.com",
 databaseURL:"https://calling-98df6-default-rtdb.firebaseio.com",
 projectId:"calling-98df6",
 appId:"1:421742710154:web:8ac1621ab81b45edd2cc73"
});

const ADMIN_EMAIL = "surajpatawa995@gmail.com";
const auth = firebase.auth();
const db = firebase.database();

/* ðŸ” AUTH CHECK */
auth.onAuthStateChanged(u=>{
 if(!u) return;

 if(u.email !== ADMIN_EMAIL){
  alert("Access denied");
  auth.signOut();
  return;
 }

 loginBox.style.display="none";
 adminBox.style.display="block";

 loadPayments();
 loadWithdraws();
});

/* LOGIN */
function adminLogin(){
 auth.signInWithEmailAndPassword(email.value,password.value)
 .catch(e=>alert(e.message));
}

/* ================= PAYMENTS ================= */
function loadPayments(){
 db.ref("payments").orderByChild("status").equalTo("pending")
 .on("value",snap=>{
  payments.innerHTML="";
  snap.forEach(p=>{
   const d=p.val();
   payments.innerHTML+=`
    <div class="card">
     <small>UID: ${d.uid}</small><br>
     Amount: â‚¹${d.amount}<br>
     UTR: <b>${d.utr}</b><br>
     <button onclick="approvePayment('${p.key}','${d.uid}')">
      Approve Payment
     </button>
    </div>
   `;
  });
 });
}

function approvePayment(pid,uid){
 db.ref("payments/"+pid+"/status").set("approved");
 db.ref("users/"+uid+"/paid").set(true); // ðŸ”¥ USER AUTO UNLOCK
 alert("Payment approved & user unlocked");
}

/* ================= WITHDRAW ================= */
function loadWithdraws(){
 db.ref("withdrawals").orderByChild("status").equalTo("pending")
 .on("value",snap=>{
  withdraws.innerHTML="";
  snap.forEach(w=>{
   const d=w.val();
   withdraws.innerHTML+=`
    <div class="card">
     <small>UID: ${d.uid}</small><br>
     Amount: â‚¹${d.amount}<br>
     <button onclick="approveWithdraw('${w.key}')">
      Mark Paid
     </button>
    </div>
   `;
  });
 });
}

function approveWithdraw(wid){
 db.ref("withdrawals/"+wid+"/status").set("paid");
 alert("Withdraw marked as paid");
}

/* ================= COINS MANAGER ================= */
function addCoinsAdmin(){
 const uid = coinUid.value.trim();
 const amt = parseInt(coinAmount.value);

 if(!uid || !amt || amt <= 0){
  alert("Invalid UID or amount");
  return;
 }

 const ref = db.ref("users/"+uid+"/coins");

 ref.transaction(curr=>{
  return (curr || 0) + amt;
 }, (err, committed)=>{
  if(err){
   alert("Error adding coins");
  }else if(committed){
   coinMsg.innerText = "âœ… Coins added successfully";
  }
 });
}

function deductCoinsAdmin(){
 const uid = coinUid.value.trim();
 const amt = parseInt(coinAmount.value);

 if(!uid || !amt || amt <= 0){
  alert("Invalid UID or amount");
  return;
 }

 const ref = db.ref("users/"+uid+"/coins");

 ref.once("value").then(s=>{
  const curr = s.val() || 0;
  if(curr < amt){
   alert("User has insufficient balance");
   return;
  }

  ref.set(curr - amt);
  coinMsg.innerText = "âœ… Coins deducted successfully";
 });
}
</script>

</body>
</html>